@using DevExtreme.Asp.Template.Gallery.ViewComponents

<script>
    $(() => {
        const userMenuItems = [{
            text: "Logout",
            icon: "runner",
            onClick: () => onLogoutClick()
        }];

        function onLogoutClick() {
            navigation.loadView("Auth");
            //console.log("Log out");
        }

        function onDrawerMenuButtonClick() {
            $("#layout-body").dxDrawer("instance").toggle();
        }

        $("#messages-button").dxButton({
            icon: "belloutline",
            stylingMode: "text"
        })

        $("#userPanelDropDown").dxDropDownButton({
            stylingMode: "text",
            icon: user.avatarUrl,
            showArrowIcon: false,
            dropDownOptions: {
                width: "auto"
            },
            onContentReady: (e) => {
                e.component.registerKeyHandler('downArrow', () => {
                    // userMenuSectionRef.value?.focusList();
                });
            },
            dropDownContentTemplate: (data) => {
                const wrapperDiv = $("<div class='user-info'></div>");
                wrapperDiv.append($(`<div class='user-name'>${user.name} ${user.lastName}</div>`));
                const divList = $("<div id='userInfoListRef' class='user-info-list'></div>")
                divList.dxList({
                    items: userMenuItems,
                    onItemClick: ({ itemData }) => itemData.onClick(),
                });
                return wrapperDiv.add(divList);
            },
        });
    });

    var devextreme_asp_ui_template_gallery = (function () {

        var DRAWER_OPENED_KEY = "devextreme_asp_ui_template_gallery-drawer-opened";

        var breakpoints = {
            xSmallMedia: window.matchMedia("(max-width: 599.99px)"),
            smallMedia: window.matchMedia("(min-width: 600px) and (max-width: 959.99px)"),
            mediumMedia: window.matchMedia("(min-width: 960px) and (max-width: 1279.99px)"),
            largeMedia: window.matchMedia("(min-width: 1280px)")
        };

        function getDrawer() {
            return $("#layout-body").dxDrawer("instance");
        }

        function restoreDrawerOpened() {
            var isLarge = breakpoints.largeMedia.matches;
            if (!isLarge)
                return false;

            var state = sessionStorage.getItem(DRAWER_OPENED_KEY);
            if (state === null)
                return isLarge;

            return state === "true";
        }

        function saveDrawerOpened() {
            sessionStorage.setItem(DRAWER_OPENED_KEY, getDrawer().option("opened"));
        }

        function updateDrawer() {
            var isXSmall = breakpoints.xSmallMedia.matches,
                isLarge = breakpoints.largeMedia.matches;

            getDrawer().option({
                openedStateMode: isLarge ? "shrink" : "overlap",
                revealMode: isXSmall ? "slide" : "expand",
                minSize: isXSmall ? 0 : 60,
                shading: !isLarge,
            });
        }

        function init() {
            $("#layout-drawer-scrollview").dxScrollView({ direction: "vertical" });

            $.each(breakpoints, function (_, size) {
                size.addListener(function (e) {
                    if (e.matches)
                        updateDrawer();
                });
            });

            updateDrawer();

            $('.layout-body').removeClass('layout-body-hidden');

            $("#messages-button").dxButton({
                icon: 'belloutline',
                stylingMode: "text"
            });
            loadView("/Components/GetTasksComponent/");
        }

        function navigate(url, delay) {
            if (url) {
                setTimeout(function () {
                    loadView(url);
                }, delay);
            }
        }

        function loadView(url) {
            $.get(url, function (data) {
                $("#view-placeholder").html(data);
            });
        }

        function onMenuButtonClick() {
            getDrawer().toggle();
            saveDrawerOpened();
        }

        function onTreeViewItemClick(e) {
            var drawer = getDrawer();
            var savedOpened = restoreDrawerOpened();
            var actualOpened = drawer.option("opened");

            if (!actualOpened) {
                drawer.show();
            } else {
                var willHide = !savedOpened || !breakpoints.largeMedia.matches;
                if (willHide)
                    drawer.hide();
                navigation.loadView(e.itemData.ViewName);
            }
        }

        return {
            init: init,
            restoreDrawerOpened: restoreDrawerOpened,
            onMenuButtonClick: onMenuButtonClick,
            onTreeViewItemClick: onTreeViewItemClick
        };
    })();

    document.addEventListener("DOMContentLoaded", function documentReady() {
        this.removeEventListener("DOMContentLoaded", documentReady);
        devextreme_asp_ui_template_gallery.init();
    });
</script>

<div class="content">
    <div id="side-nav-outer-toolbar">
        <header>
            <div class="header-component layout-header">
                @(Html.DevExtreme().Toolbar()
                        .ElementAttr(new { @class = "header-toolbar" })
                        .Items(items => {
                            items.Add()
                        .Widget(w => w
                        .Button()
                        .Icon("menu")
                        .StylingMode(ButtonStylingMode.Text)
                        .OnClick("devextreme_asp_ui_template_gallery.onMenuButtonClick")
                        )
                        .Location(ToolbarItemLocation.Before)
                        .CssClass("menu-button");
                            items.Add()
                        .Text("UI Template Gallery")
                        .Location(ToolbarItemLocation.Before)
                        .CssClass("header-title dx-toolbar-label");
                            items.Add()
                        .Location(ToolbarItemLocation.After)
                        .CssClass("global-search-box")
                        .Widget(w => w
                        .TextBox()
                        .Width(180)
                        .Placeholder("Search")
                        .Mode(TextBoxMode.Search)
                        .StylingMode(EditorStylingMode.Filled)
                        );
                            items.Add()
                        .LocateInMenu(ToolbarItemLocateInMenuMode.Never)
                        .Location(ToolbarItemLocation.After)
                        .Widget(w => w
                        .Button()
                        .OnInitialized("onThemeSwitcherInit")
                        .ElementAttr(new { @class = "theme-button" })
                        .StylingMode(ButtonStylingMode.Text)
                        .Icon("sun")
                        .OnClick("onThemeSwitcherClick")
                        );
                            items.Add()
                        .Location(ToolbarItemLocation.After)
                        .Template(@<text>
                    <div class="messages">
                        <div id="messages-button"></div>
                        <div class="dx-badge">4</div>
                    </div>
                </text>);
                            items.Add()
                        .Location(ToolbarItemLocation.After)
                        .LocateInMenu(ToolbarItemLocateInMenuMode.Never)
                        .Template(@<text>
                    <div>
                        <div class="user-panel"><div id="userPanelDropDown" class="user-button"></div></div>
                    </div>
                </text>);
                        })
                    )
            </div>
        </header>
        
        @(Html.DevExtreme().Drawer()
            .ID("layout-body")
            .Position(DrawerPosition.Before)
            .RevealMode(DrawerRevealMode.Expand)
            .Opened(new JS("devextreme_asp_ui_template_gallery.restoreDrawerOpened()"))
            .MinSize(48)
            .MaxSize(250)
            .CloseOnOutsideClick(false)
            .Shading(false)
            .Content(@<text>
                <div class="content">
                    <div id="navigatable-view-placeholder"></div>
                </div>
            </text>)
            .Template(new TemplateName("navigation-menu"))
        )

        @using (Html.DevExtreme().NamedTemplate("navigation-menu")) {
            <div class="menu-container">
                @(Html.DevExtreme().TreeView()
                    .DataSource(new JS(
                        "navigation.getNavigationData(true).map(item => { return {...item, ...{ text: item.Text, icon: item.Icon } } })"
                    ))
                    .ExpandEvent(TreeViewExpandEvent.Click)
                    .SelectionMode(NavSelectionMode.Single)
                    .SelectedExpr("selected")
                    .FocusStateEnabled(false)
                    .Width("100%")
                    .OnItemClick("devextreme_asp_ui_template_gallery.onTreeViewItemClick")
                )
            </div>
        }
    </div>
</div>