@using DevExtremeVSTemplateMVC.Models
@model ListViewModel

@using System.IO
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Mvc.ViewFeatures


@{
    string htmlString;

    using (var writer = new System.IO.StringWriter())
    {
        var originalWriter = ViewContext.Writer;
        ViewContext.Writer = writer;
        List<EmployeeTask> list = Model.TasksInList.Where(t => t.Status == Model.CurrentList.ListName).OrderBy(t => t.OrderIndex).ToList();
        foreach (EmployeeTask item in list)
        {
            var priority = item.Priority != null ? item.Priority.ToLower() : string.Empty;

            <div class='kanban-card dx-card theme-text-color theme-bg-color' data-task-id="@item.Id" onclick="uitgAppContext.KanbanTasksController.navigateToDetails(@item.Id)">
                <div class="card-wrapper priority-@priority">
                    <div class='card-priority'></div>
                    @(Html.DevExtreme().Button()
                        .ElementAttr(new { @class = "edit-button" })
                        .Icon("edit")
                        .StylingMode(ButtonStylingMode.Text)
                        .OnClick($"(e) => {{ uitgAppContext.KanbanTasksController.taskEditClick(e, { @Html.Raw(Json.Serialize(item)) }); }}")
                    )
                    <div class='card-content'>
                        <div class='card-subject theme-text-color'>@item.Text</div>
                        <div class='card-data'>
                            <span class='priority'>@item.Priority</span>
                            <span class='date theme-text-color'>@item.DueDate?.ToString("MM/dd/yyy")</span>
                        </div>
                        <div class='card-assignee'>
                            <span class='company theme-text-color'>@item.Company</span>
                            <div class="circle">
                                @{
                                    var initials = string.Join("", (item.Owner ?? "")
                                    .Split(' ', StringSplitOptions.RemoveEmptyEntries)
                                    .Select(n => n[0]));
                                }
                                @initials
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        ViewContext.Writer = originalWriter;
        htmlString = writer.ToString();
    }
}

<div class="list">
    <div class="list-title theme-text-color">
        <span>@Model.CurrentList.ListName</span>
        @(
            Html.DevExtreme().DropDownButton()
                .ElementAttr(new
                {
                    @class="overflow-menu"
                })
                .DataSource(new[] {
                    new { text = "Add card" },
                    new { text = "Copy list" },
                    new { text = "Move list" }
                })
                .KeyExpr("text")
                .DisplayExpr("text")
                .Visible(true)
                .Icon("overflow")
                .StylingMode(ButtonStylingMode.Text)
                .ShowArrowIcon(false)
                .DropDownOptions(options => options.Width("auto"))
            )
    </div>
    @(Html.DevExtreme().ScrollView()
        .ElementAttr(new { @class = "scrollable-list" })
        .Direction(ScrollDirection.Vertical)
        .ShowScrollbar(ShowScrollbarMode.Always)
        .Content(@<text>
        @(Html.DevExtreme().Sortable()
                .ElementAttr(new { @class = "sortable-cards" })
                .Group("cardsGroup")
                .Data("Index")
                .MoveItemOnDrop(true)
                .OnAdd("uitgAppContext.KanbanTasksController.onTaskDrop")
                .OnReorder("uitgAppContext.KanbanTasksController.onTaskDrop")
                .Content(htmlString))
        <div class="add-task">
            @(Html.DevExtreme().Button()
            .Icon("plus")
            .Text("Add Task")
            .StylingMode(ButtonStylingMode.Text)
            .Width("100%")
            .OnClick($"() => {{ uitgAppContext.KanbanTasksController.showPopupToAddTaskWithStatus('{Model.CurrentList.ListName}') }}")
            )
        </div>
    </text>))
</div>
